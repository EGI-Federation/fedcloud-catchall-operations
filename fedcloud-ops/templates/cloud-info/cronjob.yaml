{{- $values := .Values -}}
{{- range $site, $siteConf := .Values.sites }}
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: cloud-info-provider-{{ $site | lower }}
spec:
  schedule: {{ $values.cloudInfo.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: cloud-info
            image: "{{ $values.cloudInfo.image.repository }}:{{ $values.cloudInfo.image.tag }}"
            imagePullPolicy: {{ $values.cloudInfo.image.pullPolicy }}
            command: ["/usr/local/bin/ams-wrapper.sh"]
            env:
            - name: OS_AUTH_URL
              value: {{ $siteConf.endpoint }}
            - name: OS_AUTH_TYPE
              value: v3oidcaccesstoken
            - name: OS_IDENTITY_PROVIDER
              value: egi.eu
            - name: OS_PROTOCOL
              value: {{ $siteConf.protocol | default "openid" }}
            - name: CHECKIN_SECRETS_PATH
              value: /etc/checkin/
            - name: CHECKIN_OIDC_TOKEN
              value: https://aai.egi.eu/oidc/token
            - name: CLOUD_INFO_CONFIG
              value: /etc/cloud-info-provider/site/site.yaml
            - name: SITE_NAME
              value: {{ $site }}
            - name: AMS_TOKEN_FILE
              value: /etc/ams/token
            - name: AMS_PROJECT
              value: {{ $values.cloudInfo.ams.project }}
            - name: AMS_HOST
              value: {{ $values.cloudInfo.ams.host }}
            {{- if $values.cloudInfo.debug }}
            - name: DEBUG
              value: "1"
            {{- end }}
            volumeMounts:
            - mountPath: /etc/cloud-info-provider/site
              name: cloud-info-config
            {{- range $vo, $share := $siteConf.vos }}
            - mountPath: /etc/checkin/{{ $vo | lower }}
              name: checkin-creds-{{ $vo | lower | replace "." "-" }}
            {{- end }}
            - mountPath: /etc/ams
              name: ams-secret
            resources:
{{ toYaml $values.resources | indent 14 }}
          volumes:
          - name: cloud-info-config
            configMap:
              name: cloud-info-config-{{ $site | lower }}
              items:
              - key: site.yaml
                path: site.yaml
          {{- range $vo, $share := $siteConf.vos }}
          - name: checkin-creds-{{ $vo | lower | replace "." "-" }}
            secret:
              secretName: checkin-cloudinfo-creds-{{ $site | lower }}-{{ $vo | lower }}
          {{- end }}
          - name: ams-secret
            secret:
              secretName: ams-secret
        {{- with $values.nodeSelector }}
          nodeSelector:
{{ toYaml . | indent 12 }}
        {{- end }}
        {{- with $values.affinity }}
          affinity:
{{ toYaml . | indent 12 }}
        {{- end }}
        {{- with $values.tolerations }}
          tolerations:
{{ toYaml . | indent 12 }}
        {{- end }}
{{- end }}
